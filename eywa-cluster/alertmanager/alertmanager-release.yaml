apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: alertmanager
  namespace: flux-system
spec:
  interval: 5m0s
  chart:
    spec:
      chart: alertmanager
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
  releaseName: alertmanager
  targetNamespace: faas-system
  values:
    installNamespace: false
    service:
      port: 80
    config:
      route:
        group_by: ['alertname', 'cluster', 'service']
        group_wait: 5s
        group_interval: 10s
        repeat_interval: 30s
        receiver: scale-up
        routes:
        - match:
            service: gateway
            receiver: scale-up
            severity: major
      inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'cluster', 'service']
      receivers:
      - name: 'scale-up'
        webhook_configs:
          - url: http://gateway.faas-system:8080/eywa/api/system/alert
            send_resolved: true
